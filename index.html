<html>

<head>
  <script lang="javascript" src="lib/xlsx.full.min.js"></script>
</head>

<body>
  <div>
    <input id="inputExcel" type="file" accept=".xls,.xlsx">
    <input id="fromRow" type="number" placeholder="從第幾行？">
    <input id="toRow" type="number" placeholder="到第幾行？">
    <button type="button" onclick="transformShiftPlanExcelToImportExcel()">轉換成匯入excel</button>
  </div>
  <script>
    function transformShiftPlanExcelToImportExcel() {
      // ToDo:
      // 2. use some third party js library to extract data from the users's excel
      // 3. according to the import excel template, fill in the template and return it to the user
      var file = document.querySelector('#inputExcel').files[0];
      var reader = new FileReader();
      reader.onload = function (e) {
        var data = new Uint8Array(e.target.result);
        var workbook = XLSX.read(data, { type: 'array', cellStyles: true });
        processWorkBookAndPopUpDownloadExcel(workbook);
      };
      reader.readAsArrayBuffer(file);
    }

    function processWorkBookAndPopUpDownloadExcel(workbook) {
      const firstSheetName = workbook.SheetNames[0];
      const sheetData = workbook.Sheets[firstSheetName];

      const inputTableTitle = sheetData.B1.v;
      const exportWorkbookFileName = "班表匯入_" + inputTableTitle;

      extractInputWorkbookAndGetExportWorkbook(workbook);

      // /XLSX.writeFile(exportWorkbook, `${exportWorkbookFileName}.xlsx`);
    }

    function extractInputWorkbookAndGetExportWorkbook(inputWorkbook) {
      const exportWorkbook = getInitializedExportWorkbook();

      const firstSheetName = workbook.SheetNames[0];
      const sheetData = workbook.Sheets[firstSheetName];

      // ToDo:
      // 1. A欄表示員工編號，只有裡面有值的那幾行需要爬資料
      // 可以用Object.keys()得到sheetData物件有哪些key
      // 再用陣列的filter功能以及字串的regex去排除不要的資料
      // (像是AA2就不是我們要的欄位，我們只要A+數字的欄位，還有欄位裡面沒有值的也不要)
      // 
      // 2. 寫爬資料的邏輯，然後放資料進去exportWorkbook


      const inputTableTitle = sheetData.B1.v;
      const year = getYear(inputTableTitle);
      const month = getMonth(inputTableTitle);
    }

    function getInitializedExportWorkbook() {
      const exportWorkbook = XLSX.utils.book_new();
      exportWorkbook.Props = {
        Author: "This Wayne",
        CreatedDate: new Date()
      }

      const sheetName = 'Import file';
      exportWorkbook.SheetNames.push(sheetName);

      const templateHeaders = [[
        '*工號', '姓名', '*日期(YYYY/MM/DD)', '*狀態代碼',
        '班次代碼', '上班時間(HH:mm)', '下班時間(HH:mm)', '全天支援單位代碼',
        '(1)支援單位代碼', '(1)支援起時-hh:mm', '(1)支援迄時-hh:mm',
        '(2)支援單位代碼', '(2)支援起時-hh:mm', '(2)支援迄時-hh:mm',
        '(3)支援單位代碼', '(3)支援起時-hh:mm', '(3)支援迄時-hh:mm']];
      const sheetHeaders = XLSX.utils.aoa_to_sheet(templateHeaders);
      exportWorkbook.Sheets[sheetName] = sheetHeaders;
      return exportWorkbook;
    }

    function getYear(rawTitle) {
      return rawTitle.slice(0, rawTitle.indexOf('.'));
    }
    function getMonth(rawTitle) {
      return rawTitle.slice(rawTitle.indexOf('.') + 1, rawTitle.indexOf('月')).padStart(2, '0');
    }
  </script>
</body>

</html>